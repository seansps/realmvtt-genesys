<script>
  function onLoad() {
    // If needed, hide or unhide the ammo field
    const dataPathToWeapon = getNearestParentDataPath(dataPath);
    const weapon = api.getValue(dataPathToWeapon);

    let pathToFields = "fields";
    if (dataPathToWeapon !== "") {
      pathToFields = `${dataPathToWeapon}.fields`;
    }

    const valuesToSet = {};

    const ammoFieldShown = weapon.fields?.ammoField?.hidden === false;

    const itemQualities = weapon.data?.special || [];
    const needsAmmo = itemQualities.includes("limited-ammo");

    // We only set the ammo field if the item has the limited-ammo quality
    // and the ammo field is hidden.
    if (needsAmmo && !ammoFieldShown) {
      valuesToSet[`${pathToFields}.ammoField.hidden`] = false;
    } else if (!needsAmmo && ammoFieldShown) {
      valuesToSet[`${pathToFields}.ammoField.hidden`] = true;
    }

    // If we have stun-setting or auto-fire qualities, we need to show the stun and auto-fire buttons
    const stunSetting = itemQualities.includes("stun-setting");
    const stunButtonShown = weapon.fields?.stunBtn?.hidden === false;
    const autoFire = itemQualities.includes("auto-fire");
    const autoFireButtonShown = weapon.fields?.autoFireBtn?.hidden === false;
    if (stunSetting && !stunButtonShown) {
      valuesToSet[`${pathToFields}.stunBtn.hidden`] = false;
    } else if (!stunSetting && stunButtonShown) {
      valuesToSet[`${pathToFields}.stunBtn.hidden`] = true;
    }

    if (autoFire && !autoFireButtonShown) {
      valuesToSet[`${pathToFields}.autoFireBtn.hidden`] = false;
    } else if (!autoFire && autoFireButtonShown) {
      valuesToSet[`${pathToFields}.autoFireBtn.hidden`] = true;
    }

    // Determine if we need to show the attachments list
    const showingAttachments = weapon?.fields?.attachments?.hidden !== true;
    const attachments = weapon?.data?.attachments || [];
    // If we're showing attachments list and we no have attachments, then hide it
    const showAttachments = attachments.length > 0;

    if (showingAttachments && !showAttachments) {
      valuesToSet[`${pathToFields}.attachments.hidden`] = true;
    } else if (!showingAttachments && showAttachments) {
      valuesToSet[`${pathToFields}.attachments.hidden`] = false;
    }

    // Only update values if needed
    if (Object.keys(valuesToSet).length > 0) {
      api.setValues(valuesToSet);
    }
  }

  function onRollAttack() {
    const dataPathToWeapon = getNearestParentDataPath(dataPath);
    const weapon = api.getValue(dataPathToWeapon);
    // If this is a vehicle attack, we set the scale to planetary
    let scale = "personal";
    if (dataPathToWeapon.includes("activeVehicle")) {
      scale = "planetary";
    }
    rollAttack(record, weapon, dataPathToWeapon, "attack", scale);
  }

  function onRollStun() {
    const dataPathToWeapon = getNearestParentDataPath(dataPath);
    const weapon = api.getValue(dataPathToWeapon);
    let scale = "personal";
    if (dataPathToWeapon.includes("activeVehicle")) {
      scale = "planetary";
    }
    rollAttack(record, weapon, dataPathToWeapon, "stun-setting", scale);
  }

  function onRollAutoFire() {
    const dataPathToWeapon = getNearestParentDataPath(dataPath);
    const weapon = api.getValue(dataPathToWeapon);
    let scale = "personal";
    if (dataPathToWeapon.includes("activeVehicle")) {
      scale = "planetary";
    }
    rollAttack(record, weapon, dataPathToWeapon, "auto-fire", scale);
  }
</script>

<div style="display: flex; flex-direction: column">
  <!-- Main row for icon, name, buttons -->
  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 4px;
      align-items: center;
      flex-wrap: wrap;
    "
  >
    <div
      style="
        min-width: 100px;
        flex: 1;
        display: flex;
        flex-direction: row;
        gap: 0px;
      "
    >
      <div style="width: 30px; height: 30px; min-width: 30px; min-height: 30px">
        <portrait width="30px" height="30px" field="portrait"></portrait>
      </div>
      <div style="min-width: 70px; flex: 1">
        <namefield
          field="namefield"
          variant="standard"
          placeholder="Item Name..."
        ></namefield>
      </div>
    </div>
    <box field="ammoField" hidden="true">
      <div
        style="
          display: flex;
          flex-direction: row;
          gap: 4px;
          align-items: center;
        "
      >
        <label size="xs" variant="bold" label="Ammo: "></label>
        <div style="width: 60px">
          <numberfield
            onload="onLoad();"
            width="100%"
            field="ammo"
            placeholder="0"
            minvalue="0"
            variant="tooltip"
            label="Ammo Remaining"
            size="xs"
          >
          </numberfield>
        </div>
      </div>
    </box>
    <div style="width: 70px; min-width: 70px">
      <stringfield
        width="100%"
        textalign="center"
        field="range"
        label="Range"
        size="xs"
        placeholder="Range..."
        variant="tooltip-underline"
      ></stringfield>
    </div>
    <!-- Roll Attack -->
    <div style="display: flex; flex-direction: row; gap: 4px">
      <!-- Roll Damage -->
      <button
        size="xs"
        radius="xs"
        field="attackBtn"
        label="Roll Attack"
        color="primary"
        variant="light"
        onclick="onRollAttack();"
      ></button>
      <button
        size="xs"
        radius="xs"
        field="stunBtn"
        label="Roll Stun"
        color="secondary"
        variant="light"
        onclick="onRollStun();"
        hidden="true"
      ></button>
      <button
        size="xs"
        radius="xs"
        field="autoFireBtn"
        label="Roll Auto-Fire"
        hidden="true"
        color="tertiary"
        variant="light"
        onclick="onRollAutoFire();"
      ></button>
    </div>
  </div>
</div>

<list
  field="attachments"
  listtype="attack_attachment_list"
  hidden="true"
></list>
