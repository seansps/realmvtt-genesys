<script>
  function onLoad() {
    const recordType = record.recordType;
    let nearestParentDataPath = getNearestParentDataPath(dataPath);
    const specialization = api.getValue(nearestParentDataPath);

    if (!specialization) {
      return;
    }

    const initalized = specialization?.data?.initalized || false;

    if (recordType === "characters" && !initalized) {
      // Check if any talent buttons are hidden
      const listsToCheck = [
        "talent1_1",
        "talent1_2",
        "talent1_3",
        "talent1_4",
        "talent2_1",
        "talent2_2",
        "talent2_3",
        "talent2_4",
        "talent3_1",
        "talent3_2",
        "talent3_3",
        "talent3_4",
        "talent4_1",
        "talent4_2",
        "talent4_3",
        "talent4_4",
        "talent5_1",
        "talent5_2",
        "talent5_3",
        "talent5_4",
      ];
      const valuesToSet = {
        [`${nearestParentDataPath}.data.initalized`]: true,
        [`${nearestParentDataPath}.fields.signatureAbility.hidden`]: false,
      };
      listsToCheck.forEach((list) => {
        if (
          specialization?.data?.[list] &&
          specialization?.data?.[list].length > 0
        ) {
          valuesToSet[
            `${nearestParentDataPath}.data.${list}.0.fields.chosen.hidden`
          ] = false;
        }
      });
      api.setValues(valuesToSet);
    } else if (recordType === "specializations") {
      // Check if we need to show/hide dividers
      showHideDividers();
    }
  }

  function showHideDividers() {
    const nearestParentDataPath = getNearestParentDataPath(dataPath);
    const specialization = api.getValue(nearestParentDataPath) || record;
    const valuesToSet = {};

    // Check all dividers in the talent tree
    const dividersToCheck = [
      // Row 1 → Row 2 connections
      "connector2_1",
      "connector2_2",
      "connector2_3",
      "connector2_4",

      // Row 1 horizontal connections
      "h_connector1_2",
      "h_connector1_3",
      "h_connector1_4",

      // Row 2 → Row 3 connections
      "connector3_1",
      "connector3_2",
      "connector3_3",
      "connector3_4",

      // Row 2 horizontal connections
      "h_connector2_2",
      "h_connector2_3",
      "h_connector2_4",

      // Row 3 → Row 4 connections
      "connector4_1",
      "connector4_2",
      "connector4_3",
      "connector4_4",

      // Row 3 horizontal connections
      "h_connector3_2",
      "h_connector3_3",
      "h_connector3_4",

      // Row 4 → Row 5 connections
      "connector5_1",
      "connector5_2",
      "connector5_3",
      "connector5_4",

      // Row 4 horizontal connections
      "h_connector4_2",
      "h_connector4_3",
      "h_connector4_4",

      // Row 5 horizontal connections
      "h_connector5_2",
      "h_connector5_3",
      "h_connector5_4",
    ];

    dividersToCheck.forEach((divider) => {
      if (
        specialization?.data?.[divider] &&
        specialization?.data?.[divider] === "Yes" &&
        specialization?.fields?.[`${divider}_divider`]?.hidden !== false
      ) {
        valuesToSet[
          `${nearestParentDataPath}${
            nearestParentDataPath ? "." : ""
          }fields.${divider}_divider.hidden`
        ] = false;
      } else if (
        specialization?.data?.[divider] &&
        specialization?.data?.[divider] === "No" &&
        specialization?.fields?.[`${divider}_divider`]?.hidden !== true
      ) {
        valuesToSet[
          `${nearestParentDataPath}${
            nearestParentDataPath ? "." : ""
          }fields.${divider}_divider.hidden`
        ] = true;
      }
    });

    if (Object.keys(valuesToSet).length > 0) {
      api.setValues(valuesToSet);
    }
  }

  function onTalentChange() {
    // Dynamically set initial cost
    // Requery the talent list to get the latest values
    api.getRecord(record.recordType, record._id, (recordUpdated) => {
      const talents = api.getValueOnRecord(recordUpdated, dataPath);

      if (talents && talents.length > 0) {
        let cost = 5;
        if (dataPath.includes("talent1")) {
          cost = 5;
        } else if (dataPath.includes("talent2")) {
          cost = 10;
        } else if (dataPath.includes("talent3")) {
          cost = 15;
        } else if (dataPath.includes("talent4")) {
          cost = 20;
        } else if (dataPath.includes("talent5")) {
          cost = 25;
        }

        api.setValues({
          [`${dataPath}.0.data.cost`]: cost,
        });
      }
    });
  }

  function onDrop(type, recordLink) {
    // If the signature ability is dropped, we add it
    if (type === "signature_abilities") {
      onDropSignatureAbility(recordLink);
    }
  }

  function onDropSignatureAbility(recordLink) {
    // Get the signature ability
    const signatureAbilityObj = {
      ...recordLink.value,
      icon: "IconMichelinStar",
    };

    // If on a character, we add it to the signature ability list and add the cost to the spent xp
    if (record.recordType === "characters") {
      // If the signature ability is changed, we need to deduct the cost from the spent xp
      // Requery character to get latest spent xp
      const recordId = record._id;
      api.getRecord("characters", recordId, (recordUpdated) => {
        api.addValue(
          `${dataPath}.signatureAbility`,
          signatureAbilityObj,
          (recordUpdated2) => {
            const valuesToSet = {
              [`data.spentXp`]:
                (signatureAbilityObj.data?.cost || 0) +
                (recordUpdated.data.spentXp || 0),
              [`${dataPath}.oldCost`]: signatureAbilityObj.data?.cost || 0,
            };

            api.setValues(valuesToSet);
          }
        );
      });
    }
  }

  function onSignatureAbilityChange() {
    // If the signature ability is changed, we need to deduct the cost from the spent xp
    // Requery character to get latest spent xp
    const recordId = record._id;
    api.getRecord("characters", recordId, (recordUpdated) => {
      const dataPathToSpecialization = getNearestParentDataPath(dataPath);
      const specialization = api.getValue(dataPathToSpecialization);
      const valuesToSet = {
        [`data.spentXp`]:
          (recordUpdated.data.spentXp || 0) -
          (specialization.data.oldCost || 0),
      };
      api.setValues(valuesToSet);
    });
  }
</script>

<div
  style="
    display: flex;
    gap: 4px;
    flex-direction: column;
    width: 100%;
    margin-bottom: 4px;
  "
>
  <div style="display: flex; gap: 4px; width: 100%">
    <div style="width: 60px; height: 60px; min-height: 60px; min-width: 60px">
      <portrait width="60px" height="60px" field="portrait"></portrait>
    </div>
    <div style="display: flex; flex-direction: column; gap: 4px; width: 300px">
      <dropdown
        onload="onLoad();"
        width="100%"
        field="career"
        label="Careers"
        placeholder="Enter Careers..."
        multiselect="50"
        combo="true"
      ></dropdown>
    </div>
  </div>

  <label variant="bold" size="md" textalign="center" label="Talents"></label>

  <!-- Talent Tree Wrapper - uses margin auto for centering while allowing full scroll -->
  <div
    style="
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: fit-content;
      margin: 0 auto;
    "
  >
    <!-- Row 1 -->
    <div style="display: flex; gap: 4px; align-items: center">
      <!-- Talent 1 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent1_1"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector2_1_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector2_1"
            variant="default"
            size="md"
            disablediflocked="true"
            hideonlocked="true"
            onchange="showHideDividers();"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector1_2_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector1_2"
          variant="default"
          size="md"
          disablediflocked="true"
          hideonlocked="true"
          onchange="showHideDividers();"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 2 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent1_2"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector2_2_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector2_2"
            variant="default"
            hideonlocked="true"
            size="md"
            disablediflocked="true"
            onchange="showHideDividers();"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector1_3_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector1_3"
          variant="default"
          size="md"
          disablediflocked="true"
          hideonlocked="true"
          onchange="showHideDividers();"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 3 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent1_3"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector2_3_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector2_3"
            variant="default"
            hideonlocked="true"
            size="md"
            disablediflocked="true"
            onchange="showHideDividers();"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector1_4_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector1_4"
          variant="default"
          size="md"
          disablediflocked="true"
          hideonlocked="true"
          onchange="showHideDividers();"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 4 (no horizontal connector after this) -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent1_4"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector2_4_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector2_4"
            variant="default"
            size="md"
            hideonlocked="true"
            disablediflocked="true"
            onchange="showHideDividers();"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>
    </div>

    <!-- Row 2 -->
    <div style="display: flex; gap: 4px; align-items: center">
      <!-- Talent 1 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent2_1"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector3_1_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector3_1"
            variant="default"
            size="md"
            hideonlocked="true"
            disablediflocked="true"
            onchange="showHideDividers();"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector2_2_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector2_2"
          variant="default"
          size="md"
          hideonlocked="true"
          disablediflocked="true"
          onchange="showHideDividers();"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 2 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent2_2"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector3_2_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector3_2"
            variant="default"
            size="md"
            disablediflocked="true"
            hideonlocked="true"
            onchange="showHideDividers();"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector2_3_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector2_3"
          variant="default"
          size="md"
          hideonlocked="true"
          disablediflocked="true"
          onchange="showHideDividers();"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 3 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent2_3"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector3_3_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector3_3"
            variant="default"
            size="md"
            disablediflocked="true"
            hideonlocked="true"
            onchange="showHideDividers();"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector2_4_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector2_4"
          variant="default"
          size="md"
          disablediflocked="true"
          hideonlocked="true"
          onchange="showHideDividers();"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 4 (no horizontal connector after this) -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent2_4"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector3_4_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector3_4"
            variant="default"
            size="md"
            disablediflocked="true"
            hideonlocked="true"
            onchange="showHideDividers();"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>
    </div>

    <!-- Row 3 -->
    <div style="display: flex; gap: 4px; align-items: center">
      <!-- Talent 1 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent3_1"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector4_1_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector4_1"
            variant="default"
            size="md"
            onchange="showHideDividers();"
            hideonlocked="true"
            disablediflocked="true"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector3_2_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector3_2"
          variant="default"
          size="md"
          onchange="showHideDividers();"
          disablediflocked="true"
          hideonlocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 2 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent3_2"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector4_2_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector4_2"
            variant="default"
            size="md"
            onchange="showHideDividers();"
            hideonlocked="true"
            disablediflocked="true"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector3_3_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector3_3"
          variant="default"
          size="md"
          onchange="showHideDividers();"
          disablediflocked="true"
          hideonlocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 3 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent3_3"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector4_3_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector4_3"
            variant="default"
            size="md"
            onchange="showHideDividers();"
            disablediflocked="true"
            hideonlocked="true"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector3_4_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector3_4"
          variant="default"
          size="md"
          onchange="showHideDividers();"
          disablediflocked="true"
          hideonlocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 4 (no horizontal connector after this) -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent3_4"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector4_4_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector4_4"
            variant="default"
            size="md"
            onchange="showHideDividers();"
            hideonlocked="true"
            disablediflocked="true"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>
    </div>

    <!-- Row 4 -->
    <div style="display: flex; gap: 4px; align-items: center">
      <!-- Talent 1 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent4_1"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector5_1_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector5_1"
            variant="default"
            size="md"
            onchange="showHideDividers();"
            hideonlocked="true"
            disablediflocked="true"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector4_2_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector4_2"
          variant="default"
          size="md"
          onchange="showHideDividers();"
          hideonlocked="true"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 2 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent4_2"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector5_2_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector5_2"
            variant="default"
            size="md"
            onchange="showHideDividers();"
            hideonlocked="true"
            disablediflocked="true"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector4_3_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector4_3"
          variant="default"
          size="md"
          onchange="showHideDividers();"
          hideonlocked="true"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 3 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent4_3"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector5_3_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector5_3"
            variant="default"
            size="md"
            onchange="showHideDividers();"
            hideonlocked="true"
            disablediflocked="true"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector4_4_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector4_4"
          variant="default"
          size="md"
          onchange="showHideDividers();"
          hideonlocked="true"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 4 (no horizontal connector after this) -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent4_4"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <div style="position: relative; min-width: 27px; min-height: 27px">
          <box field="connector5_4_divider" hidden="true">
            <div
              style="
                position: absolute;
                top: -4px;
                left: 10px;
                right: 10px;
                bottom: 0;
                height: 36px;
                background: var(--mantine-color-primary-filled);
                opacity: 0.75;
              "
            ></div>
          </box>
          <iconbutton
            field="connector5_4"
            variant="default"
            size="md"
            onchange="showHideDividers();"
            hideonlocked="true"
            disablediflocked="true"
            options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
          ></iconbutton>
        </div>
      </div>
    </div>

    <!-- Row 5 (no vertical connectors at bottom) -->
    <div style="display: flex; gap: 4px; align-items: center">
      <!-- Talent 1 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent5_1"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector5_2_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector5_2"
          variant="default"
          size="md"
          onchange="showHideDividers();"
          hideonlocked="true"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
 {"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 2 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent5_2"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
        ></list>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector5_3_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector5_3"
          variant="default"
          size="md"
          onchange="showHideDividers();"
          hideonlocked="true"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
 {"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 3 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent5_3"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
      </div>

      <!-- Connection Horizontal -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="h_connector5_4_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: 10px;
              left: -4px;
              right: 0;
              bottom: 10px;
              width: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="h_connector5_4"
          variant="default"
          size="md"
          onchange="showHideDividers();"
          hideonlocked="true"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
        ></iconbutton>
      </div>

      <!-- Talent 4 (no horizontal connector after this, no vertical connector below) -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent5_4"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="specialization_talent_list"
          onchange="onTalentChange();"
        ></list>
      </div>
    </div>
  </div>
  <!-- End Talent Tree Wrapper -->
</div>

<!-- List here for signature ability, only allowing 1, and only shown if on a character -->
<list
  field="signatureAbility"
  hidden="true"
  listtype="specialization_signature_ability_list"
  onchange="onSignatureAbilityChange();"
></list>
