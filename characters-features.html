<script>
  function onLoad() {
    const talentLabel = record?.data?.talentLabel;
    if (talentLabel === undefined) {
      recalculateTalentLabel(record);
    }
  }

  function onDrop(type, recordLink) {
    if (type === "specializations") {
      onDropSpecialization(type, recordLink);
    } else if (type === "abilities") {
      onDropAbility(type, recordLink);
    } else if (type === "talents") {
      onDropTalent(recordLink);
    }
  }

  function onDropSpecialization(type, recordLink) {
    const specializationName = recordLink.tooltip;
    const specializationObj = { ...recordLink.value, icon: "IconStars" };

    api.addValue("data.specializations", specializationObj, () => {
      const valuesToSet = {};

      // Mark all career skills
      const careerSkills = specializationObj?.data?.skills || "";
      const careerSkillsArray = careerSkills.toLowerCase().split(",");
      // Filter empty strings and trim whitespace
      const careerSkillsArrayFiltered = careerSkillsArray
        .filter((skill) => skill.trim() !== "")
        .map((skill) => skill.trim());
      const skills = record?.data?.skills || [];
      skills.forEach((skill, index) => {
        if (
          careerSkillsArrayFiltered.includes(skill.name.toLowerCase().trim())
        ) {
          valuesToSet[`data.skills.${index}.data.careerOrMinionSkill`] = true;
        }
      });

      if (Object.keys(valuesToSet).length > 0) {
        api.setValues(valuesToSet);
      }
    });
  }

  function onChangeTalents() {
    const valuesToSet = {};
    recalculateTalentLabel(record, valuesToSet);
    updateAttributes(record, valuesToSet);
    if (Object.keys(valuesToSet).length > 0) {
      api.setValues(valuesToSet);
    }
  }

  function onDropTalent(recordLink) {
    const talent = recordLink?.value;
    if (!talent) return;

    // Add the talent to the list
    // If the talent is ranked, find the existing talent with the same name and add the rank
    // If the talent is not ranked, add it to the list
    const rankedTalent = talent?.data?.ranked === "yes" ? true : false;

    // If it is ranked, check if it already exists in the talents list
    const talentId = rankedTalent ? talent._id : generateUuid();
    const existingTalent = record?.data?.talents?.find(
      (t) => t._id === talentId
    );
    const existingTalentIndex = record?.data?.talents?.findIndex(
      (t) => t._id === talentId
    );

    if (
      rankedTalent &&
      existingTalentIndex !== undefined &&
      existingTalentIndex >= 0
    ) {
      // Update the rank
      const newRank = (existingTalent?.data?.rank || 1) + 1;
      api.setValues(
        {
          [`data.talents.${existingTalentIndex}.data.rank`]: newRank,
        },
        () => {
          api.getRecord(record.recordType, record._id, (actualRecord) => {
            const valuesToSet = {};

            // Calculate XP cost for the new rank
            const baseTier = existingTalent?.data?.tier || 1;
            const actualTier = Math.min(5, baseTier + (newRank - 1));

            // Calculate cost: each rank costs the tier cost of the next tier
            let tierCost = [5, 10, 15, 20, 25][actualTier - 1];

            // Update spent XP
            const currentSpentXp = actualRecord?.data?.spentXp || 0;
            valuesToSet["data.spentXp"] = currentSpentXp + tierCost;

            // Show notification
            api.showNotification(
              `Talent rank increased to ${newRank}. XP spent: ${tierCost}`,
              "green",
              "Talent Rank Increased"
            );

            recalculateTalentLabel(actualRecord, valuesToSet);
            updateAttributes(actualRecord, valuesToSet);
            if (Object.keys(valuesToSet).length > 0) {
              api.setValues(valuesToSet);
            }
          });
        }
      );
    } else {
      // Add the talent to the list
      const talents = [...(record?.data?.talents || [])];
      const newTalent = {
        ...talent,
        _id: talentId,
        data: {
          ...talent?.data,
          rank: 1,
        },
        fields: {
          ...talent?.fields,
          useButton: {
            // Unhide the use button if not passive
            hidden: !(talent?.data?.activation || "")
              .toLowerCase()
              .includes("active"),
          },
        },
      };

      talents.push(newTalent);
      api.setValues(
        {
          [`data.talents`]: talents,
        },
        () => {
          api.getRecord(record.recordType, record._id, (actualRecord) => {
            const valuesToSet = {};

            // Calculate XP cost for the new talent
            const baseTier = newTalent?.data?.tier || 1;
            const tierCost = [5, 10, 15, 20, 25][baseTier - 1];

            // Update spent XP
            const currentSpentXp = actualRecord?.data?.spentXp || 0;
            valuesToSet["data.spentXp"] = currentSpentXp + tierCost;

            // Show notification
            api.showNotification(
              `Talent added. XP spent: ${tierCost}`,
              "green",
              "Talent Added"
            );

            recalculateTalentLabel(actualRecord, valuesToSet);
            updateAttributes(actualRecord, valuesToSet);
            if (Object.keys(valuesToSet).length > 0) {
              api.setValues(valuesToSet);
            }
          });
        }
      );
    }
  }

  function onDropAbility(type, recordLink) {
    const abilityName = recordLink.tooltip;
    const abilityObj = { ...recordLink.value, icon: "IconWand" };

    api.addValue("data.abilities", abilityObj, () => {
      const valuesToSet = {};
      api.setValues(valuesToSet);
    });
  }

  function onChangeTalentStyle(value) {
    const talentStyle = value || "pyramid";
    if (talentStyle === "pyramid") {
      api.setValues({
        "fields.specTrees.hidden": true,
        "fields.talentPyramid.hidden": false,
      });
    } else {
      api.setValues({
        "fields.specTrees.hidden": false,
        "fields.talentPyramid.hidden": true,
      });
    }
  }
</script>

<div style="display: flex; flex-direction: column; gap: 4px">
  <label
    variant="bold"
    size="md"
    label="Archetype Features"
    textalign="center"
  ></label>
  <list listtype="character_species_details_list" field="species"></list>
  <label
    field="speciesDetailsLabel"
    size="sm"
    width="100%"
    variant="unstyled"
    textalign="center"
    label="Drag and Drop an Archetype on the Main Tab"
  ></label>

  <label variant="bold" size="md" label="Talents" textalign="center"></label>

  <div
    style="
      display: flex;
      gap: 4px;
      width: 100%;
      margin-bottom: 8px;
      align-items: flex-end;
    "
  >
    <dropdown
      field="talentSetting"
      hideonlocked="true"
      label="Talent Style"
      defaultvalue="pyramid"
      onload="onLoad();"
      onchange="onChangeTalentStyle(value);"
      placeholder="Talent Style"
      options='[{"label": "Talent Pyramid", "value": "pyramid"}, {"label": "Specialization Trees", "value": "trees"}]'
    ></dropdown>
    <div style="flex-grow: 1">
      <label
        textalign="right"
        variant="bold"
        size="xs"
        field="talentLabel"
      ></label>
    </div>
  </div>

  <box field="talentPyramid">
    <list
      listtype="character_talents_list"
      emptylisttext="Drag Talents on the Features Tab"
      field="talents"
      onchange="onChangeTalents()"
    ></list>
  </box>

  <box field="specTrees" hidden="true">
    <label
      variant="bold"
      size="md"
      label="Specializations"
      textalign="center"
    ></label>

    <label
      size="sm"
      label="Click a Specialization's Icon to View the Tree and Add Talents"
      textalign="center"
    ></label>

    <list
      listtype="character_specialization_list"
      field="specializations"
      variant="striped"
    ></list>

    <div style="margin-top: 8px"></div>

    <label variant="bold" size="md" label="Talents" textalign="center"></label>

    <list
      listtype="character_talents_list"
      field="talents"
      variant="striped"
    ></list>
  </box>
</div>
