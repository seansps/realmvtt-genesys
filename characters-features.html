<script>
  function onDrop(type, recordLink) {
    if (type === "specializations") {
      onDropSpecialization(type, recordLink);
    } else if (type === "force_powers") {
      onDropForcePower(type, recordLink);
    }
  }

  function onDropSpecialization(type, recordLink) {
    const specializationName = recordLink.tooltip;
    const specializationObj = { ...recordLink.value, icon: "IconStars" };

    api.addValue("data.specializations", specializationObj, () => {
      const valuesToSet = {};

      // Mark all career skills
      const careerSkills = specializationObj?.data?.skills || "";
      const careerSkillsArray = careerSkills.toLowerCase().split(",");
      // Filter empty strings and trim whitespace
      const careerSkillsArrayFiltered = careerSkillsArray
        .filter((skill) => skill.trim() !== "")
        .map((skill) => skill.trim());
      const skills = record?.data?.skills || [];
      skills.forEach((skill, index) => {
        if (
          careerSkillsArrayFiltered.includes(skill.name.toLowerCase().trim())
        ) {
          valuesToSet[`data.skills.${index}.data.careerOrMinionSkill`] = true;
        }
      });

      if (Object.keys(valuesToSet).length > 0) {
        api.setValues(valuesToSet);
      }
    });
  }

  function onDropForcePower(type, recordLink) {
    const forcePowerName = recordLink.tooltip;
    const forcePowerObj = { ...recordLink.value, icon: "IconWand" };

    api.addValue("data.forcePowers", forcePowerObj, () => {
      const valuesToSet = {};

      // Add cost to spent xp
      valuesToSet[`data.spentXp`] =
        (record?.data?.spentXp || 0) + (forcePowerObj?.data?.cost || 0);

      api.setValues(valuesToSet);
    });
  }
</script>

<div style="display: flex; flex-direction: column; gap: 4px">
  <label
    variant="bold"
    size="md"
    label="Specializations"
    textalign="center"
  ></label>

  <label
    size="sm"
    label="Click a Specialization's Icon to View the Tree and Add Talents"
    textalign="center"
  ></label>

  <list
    listtype="character_specialization_list"
    field="specializations"
    variant="striped"
  ></list>

  <div style="margin-top: 8px"></div>

  <label variant="bold" size="md" label="Talents" textalign="center"></label>

  <list
    listtype="character_talents_list"
    field="talents"
    variant="striped"
  ></list>

  <div style="margin-top: 8px"></div>

  <label
    variant="bold"
    size="md"
    label="Species Features"
    textalign="center"
  ></label>
  <list listtype="character_species_details_list" field="species"></list>
  <label
    field="speciesDetailsLabel"
    size="sm"
    width="100%"
    variant="unstyled"
    textalign="center"
    label="Drag and Drop a Species on the Main Tab"
  ></label>

  <div style="margin-top: 8px"></div>

  <label
    variant="bold"
    size="md"
    label="Force Powers"
    textalign="center"
  ></label>

  <list
    listtype="character_force_powers_list"
    field="forcePowers"
    variant="striped"
  ></list>
</div>
