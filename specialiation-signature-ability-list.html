<script>
  function onLoad() {
    const recordType = record.recordType;
    let nearestParentDataPath = getNearestParentDataPath(dataPath);
    const signatureAbility = api.getValue(nearestParentDataPath);

    if (!signatureAbility) {
      return;
    }

    const initalized = signatureAbility?.data?.initalized || false;

    if (recordType === "characters" && !initalized) {
      // Check if any talent buttons are hidden
      const listsToCheck = [
        "talent1_1",
        "talent1_2",
        "talent1_3",
        "talent1_4",
        "talent2_1",
        "talent2_2",
        "talent2_3",
        "talent2_4",
      ];
      const valuesToSet = {
        [`${nearestParentDataPath}.data.initalized`]: true,
      };
      listsToCheck.forEach((list) => {
        if (
          signatureAbility?.data?.[list] &&
          signatureAbility?.data?.[list].length > 0
        ) {
          valuesToSet[
            `${nearestParentDataPath}.data.${list}.0.fields.chosen.hidden`
          ] = false;
        }
      });
      api.setValues(valuesToSet);
    }
  }

  function onTalentChange() {
    // Dynamically set initial cost
    const talents = api.getValue(dataPath);

    if (talents && talents.length > 0) {
      let cost = 10;
      if (dataPath.includes("talent1")) {
        cost = 10;
      } else if (dataPath.includes("talent2")) {
        cost = 15;
      }

      api.setValues({
        [`${dataPath}.0.data.cost`]: cost,
      });
    }
  }
</script>

<div
  style="
    display: flex;
    gap: 4px;
    flex-direction: column;
    width: 100%;
    margin-bottom: 4px;
  "
>
  <!-- Signature Ability Tree Wrapper - uses margin auto for centering while allowing full scroll -->
  <div
    style="
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: fit-content;
      margin: 0 auto;
    "
  >
    <!-- Connectors to Spec Tree -->
    <div style="display: flex; gap: 36px; align-items: center">
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
          width: 250px;
        "
      >
        <iconbutton
          field="connector0_1"
          onload="onLoad();"
          variant="default"
          size="md"
          disablediflocked="true"
          options='[{"label": "Not Connected to Spec Tree", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected Up to Spec Tree", "value": "Yes", "icon": "IconArrowUp"}]'
        ></iconbutton>
      </div>
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
          width: 250px;
        "
      >
        <iconbutton
          field="connector0_2"
          variant="default"
          size="md"
          disablediflocked="true"
          options='[{"label": "Not Connected to Spec Tree", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected Up to Spec Tree", "value": "Yes", "icon": "IconArrowUp"}]'
        ></iconbutton>
      </div>
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
          width: 250px;
        "
      >
        <iconbutton
          field="connector0_3"
          variant="default"
          size="md"
          disablediflocked="true"
          options='[{"label": "Not Connected to Spec Tree", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected Up to Spec Tree", "value": "Yes", "icon": "IconArrowUp"}]'
        ></iconbutton>
      </div>
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
          width: 250px;
        "
      >
        <iconbutton
          field="connector0_4"
          variant="default"
          size="md"
          disablediflocked="true"
          options='[{"label": "Not Connected to Spec Tree", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected Up to Spec Tree", "value": "Yes", "icon": "IconArrowUp"}]'
        ></iconbutton>
      </div>
    </div>

    <!-- Portrait and Description-->
    <div style="display: flex; gap: 4px">
      <div style="width: 34px; height: 34px; min-height: 34px; min-width: 34px">
        <portrait width="34px" height="34px" field="portrait"></portrait>
      </div>
      <div style="display: flex; align-items: center; gap: 4px; width: 100%">
        <namefield
          width="100%"
          field="namefield"
          variant="tooltip-underline"
          label="Name"
          placeholder="Enter Name..."
        ></namefield>
      </div>
    </div>
    <accordion
      width="100%"
      field="talentAccordion"
      label="Description"
      size="xs"
      variant="separated"
    >
      <richtextfield
        width="100%"
        field="description"
        label="Description"
        placeholder="Enter Description..."
        disablecontrols="true"
      ></richtextfield>
    </accordion>
    <div
      style="
        display: flex;
        gap: 4px;
        width: 100%;
        justify-content: center;
        margin-top: 4px;
      "
    >
      <numberfield
        width="100px"
        textalign="center"
        field="cost"
        label="Cost"
        variant="tooltip"
        hidecontrols="true"
        placeholder="Enter Cost..."
      ></numberfield>
    </div>

    <!-- Row 1 - Talents -->
    <div style="display: flex; gap: 4px; align-items: center">
      <!-- Talent 1 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <iconbutton
          field="connector1_1"
          variant="default"
          size="md"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
        <list
          field="talent1_1"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="signature_ability_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <iconbutton
          field="connector2_1"
          variant="default"
          size="md"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
      </div>

      <!-- Connection Horizontal -->
      <iconbutton
        field="h_connector1_2"
        variant="default"
        size="md"
        disablediflocked="true"
        options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
      ></iconbutton>

      <!-- Talent 2 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <iconbutton
          field="connector1_2"
          variant="default"
          size="md"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
        <list
          field="talent1_2"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="signature_ability_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <iconbutton
          field="connector2_2"
          variant="default"
          size="md"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
      </div>

      <!-- Connection Horizontal -->
      <iconbutton
        field="h_connector1_3"
        variant="default"
        size="md"
        disablediflocked="true"
        options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
      ></iconbutton>

      <!-- Talent 3 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <iconbutton
          field="connector1_3"
          variant="default"
          size="md"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
        <list
          field="talent1_3"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="signature_ability_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <iconbutton
          field="connector2_3"
          variant="default"
          size="md"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
      </div>

      <!-- Connection Horizontal -->
      <iconbutton
        field="h_connector1_4"
        variant="default"
        size="md"
        disablediflocked="true"
        options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
      ></iconbutton>

      <!-- Talent 4 (no horizontal connector after this) -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <iconbutton
          field="connector1_4"
          variant="default"
          size="md"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
        <list
          field="talent1_4"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="signature_ability_talent_list"
          onchange="onTalentChange();"
        ></list>
        <!-- Connection Vertical -->
        <iconbutton
          field="connector2_4"
          variant="default"
          size="md"
          disablediflocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
      </div>
    </div>

    <!-- Row 2 - Talents -->
    <div style="display: flex; gap: 4px; align-items: center">
      <!-- Talent 1 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent2_1"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="signature_ability_talent_list"
          onchange="onTalentChange();"
        ></list>
      </div>

      <!-- Connection Horizontal -->
      <iconbutton
        field="h_connector2_2"
        variant="default"
        size="md"
        disablediflocked="true"
        options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
 {"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
      ></iconbutton>

      <!-- Talent 2 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent2_2"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="signature_ability_talent_list"
          onchange="onTalentChange();"
        ></list>
      </div>

      <!-- Connection Horizontal -->
      <iconbutton
        field="h_connector2_3"
        variant="default"
        size="md"
        disablediflocked="true"
        options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
 {"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
      ></iconbutton>

      <!-- Talent 3 -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent2_3"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="signature_ability_talent_list"
          onchange="onTalentChange();"
        ></list>
      </div>

      <!-- Connection Horizontal -->
      <iconbutton
        field="h_connector2_4"
        variant="default"
        size="md"
        disablediflocked="true"
        options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
 {"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
      ></iconbutton>

      <!-- Talent 4 (no horizontal connector after this) -->
      <div
        style="
          display: flex;
          flex-direction: column;
          gap: 4px;
          justify-content: center;
          align-items: center;
        "
      >
        <list
          field="talent2_4"
          size="xs"
          variant="outline"
          width="250px"
          height="200px"
          listtype="signature_ability_talent_list"
          onchange="onTalentChange();"
        ></list>
      </div>
    </div>
  </div>
  <!-- End Signature Ability Tree Wrapper -->
</div>
