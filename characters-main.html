<script>
  function onDrop(type, recordLink) {
    if (type === "species") {
      onDropSpecies(type, recordLink);
    } else if (type === "careers") {
      onDropCareer(type, recordLink);
    } else if (type === "conditions") {
      onDropCondition(type, recordLink);
    }
  }

  function onDropSpecies(type, recordLink) {
    const species = record?.data?.species || [];
    const speciesName = recordLink.tooltip;
    const speciesObj = { ...recordLink.value, icon: "IconAlien" };

    const setValues = (updatedRecord) => {
      // Set species name, initial characteristics, initial XP
      const xpSpent = parseInt(record?.data?.spentXp || "0", 10);
      const xpCur = parseInt(record?.data?.xp || "0", 10);
      const valuesToSet = {
        "data.speciesName": speciesName,
        "fields.species.hidden": false,
        "data.brawn": speciesObj?.data?.brawn || 0,
        "data.agility": speciesObj?.data?.agility || 0,
        "data.intellect": speciesObj?.data?.intellect || 0,
        "data.cunning": speciesObj?.data?.cunning || 0,
        "data.willpower": speciesObj?.data?.willpower || 0,
        "data.presence": speciesObj?.data?.presence || 0,
        "data.xp": xpCur,
        "fields.speciesDetailsLabel.hidden": true,
      };

      if (xpSpent === 0 || xpCur === 0) {
        // We have no XP or haven't spent XP, so just set our current XP to initial XP
        valuesToSet["data.xp"] = speciesObj?.data?.startingXp || 0;
      }

      // First set the values, then update the attributes to get the new thresholds
      api.setValues(valuesToSet, (updatedRecord2) => {
        updateAttributes(updatedRecord2);
      });
    };

    if (species.length > 0) {
      // Replace existing species
      api.removeValue("data.species", 0, () => {
        api.addValue("data.species", speciesObj, setValues);
      });
    } else {
      api.addValue("data.species", speciesObj, setValues);
    }
  }

  function onDropCareer(type, recordLink) {
    const careers = record?.data?.careers || [];
    const careerName = recordLink.tooltip;
    const careerObj = { ...recordLink.value, icon: "IconBadge" };

    // We allow multiple careers, so we just add it to the list
    api.addValue("data.careers", careerObj, () => {
      const valuesToSet = {
        "data.careerName": careerName,
        "fields.careers.hidden": false,
        "data.forceRating":
          (careerObj?.data?.forceRating || 0) +
          (record?.data?.forceRating || 0),
      };

      // Mark all career skills
      const careerSkills = careerObj?.data?.skills || "";
      const careerSkillsArray = careerSkills.toLowerCase().split(",");
      // Filter empty strings and trim whitespace
      const careerSkillsArrayFiltered = careerSkillsArray
        .filter((skill) => skill.trim() !== "")
        .map((skill) => skill.trim());
      const skills = record?.data?.skills || [];
      skills.forEach((skill, index) => {
        if (
          careerSkillsArrayFiltered.includes(skill.name.toLowerCase().trim())
        ) {
          valuesToSet[`data.skills.${index}.data.careerOrMinionSkill`] = true;
        }
      });

      api.setValues(valuesToSet, (updatedRecord) => {
        updateAttributes(updatedRecord, valuesToSet);
      });
    });
  }

  function onDeleteSpecies() {
    const valuesToSet = {
      "data.speciesName": "",
      "fields.species.hidden": true,
      "fields.speciesDetailsLabel.hidden": false,
    };

    updateAttributes(record, valuesToSet);

    api.setValues(valuesToSet);
  }

  function onDeleteCareer() {
    const valuesToSet = {
      "data.careerName": "",
      "fields.careers.hidden": true,
    };

    updateAttributes(record, valuesToSet);

    api.setValues(valuesToSet);
  }

  function onDropCondition(type, recordLink) {
    // Requery the record to get the latest record
    api.getRecord(record.recordType, record._id, (actualRecord) => {
      addConditionToRecord(actualRecord, recordLink);
    });
  }

  function onChangeConditions() {
    // Recalculate wounds and strain, and other attributes
    const deletedItem = data.deletedItem;
    if (!deletedItem) return;

    onConditionChange(record, deletedItem);
  }

  function updateForceRating() {
    const baseForceRating = parseInt(record?.data?.forceRating || "0", 10);
    const committedForce = parseInt(record?.data?.committedForce || "0", 10);
    const remainingForce = Math.max(0, baseForceRating - committedForce);

    api.setValues({
      "data.totalForceRating": baseForceRating,
      "data.remainingForce": remainingForce,
    });
  }

  function onLoadCharacter() {
    // Initialize skills if needed
    initializeSkills(record);
  }

  function rest() {
    const currentWounds = parseInt(record?.data?.wounds || "0", 10);
    const newWounds = Math.max(0, currentWounds - 1);

    const valuesToSet = {
      "data.healingUsed": 0,
    };

    // Use updateAttribute to properly recalculate remaining values
    updateAttribute(
      { record, attribute: "wounds", value: newWounds },
      valuesToSet
    );
    updateAttribute({ record, attribute: "strain", value: 0 }, valuesToSet);

    api.setValues(valuesToSet);

    api.sendMessage(
      `Resting for day. Recovered 1 wound (${currentWounds} â†’ ${newWounds}) and all strain.`
    );
  }

  function showObligationTable() {
    // First get the party characters
    api.getParty((party) => {
      // Collect all obligations from all characters
      let allObligations = [];

      // First, calculate total obligation for each character
      const characterTotals = party.map((character) => {
        const obligations = character.data?.obligations || [];
        const totalValue = obligations.reduce((sum, obligation) => {
          return sum + parseInt(obligation.data?.value || "0", 10);
        }, 0);

        return {
          character,
          totalValue,
          obligations,
        };
      });

      // Sort characters by total obligation value (highest to lowest)
      characterTotals.sort((a, b) => b.totalValue - a.totalValue);

      // Now collect all obligations in the correct order
      characterTotals.forEach((charData) => {
        charData.obligations.forEach((obligation) => {
          allObligations.push({
            characterName: charData.character.name,
            obligationType: obligation.name,
            value: parseInt(obligation.data?.value || "0", 10),
          });
        });
      });

      // Calculate cumulative ranges
      let currentTotal = 0;
      const obligationRanges = allObligations.map((obligation) => {
        const rangeStart = currentTotal + 1;
        currentTotal += obligation.value;
        const rangeEnd = currentTotal;

        return {
          ...obligation,
          range: `${rangeStart}-${rangeEnd}`,
          rangeStart,
          rangeEnd,
        };
      });

      // Calculate total party obligation
      const totalObligation = currentTotal;

      // Create the markdown table header
      let tableMarkdown = "## Obligation Check Chart\n\n";
      tableMarkdown += "| Range | Obligation Type | Character |\n";
      tableMarkdown += "|-------|----------------|-----------|\n";

      // Add each obligation to the table
      obligationRanges.forEach((obligation) => {
        tableMarkdown += `| ${obligation.range} | ${obligation.obligationType} | ${obligation.characterName} |\n`;
      });

      // Add total obligation information
      tableMarkdown += `\n**Total Party Obligation: ${totalObligation}**\n\n`;

      // Send the table to the chat
      api.sendMessage(tableMarkdown);
    });
  }

  function rollObligation() {
    api.promptRoll(
      "Obligation Roll",
      "1d100",
      [],
      { isNarrative: false },
      "obligation"
    );
  }

  function showDutyTable() {
    // First get the party characters
    api.getParty((party) => {
      // Collect all duties from all characters
      let allDuties = [];

      // First, calculate total duty for each character
      const characterTotals = party.map((character) => {
        const duties = character.data?.duties || [];
        const totalValue = duties.reduce((sum, duty) => {
          return sum + parseInt(duty.data?.value || "0", 10);
        }, 0);

        return {
          character,
          totalValue,
          duties,
        };
      });

      // Sort characters by total duty value (highest to lowest)
      characterTotals.sort((a, b) => b.totalValue - a.totalValue);

      // Now collect all duties in the correct order
      characterTotals.forEach((charData) => {
        charData.duties.forEach((duty) => {
          allDuties.push({
            characterName: charData.character.name,
            dutyType: duty.name,
            value: parseInt(duty.data?.value || "0", 10),
          });
        });
      });

      // Calculate cumulative ranges
      let currentTotal = 0;
      const dutyRanges = allDuties.map((duty) => {
        const rangeStart = currentTotal + 1;
        currentTotal += duty.value;
        const rangeEnd = currentTotal;

        return {
          ...duty,
          range: `${rangeStart}-${rangeEnd}`,
          rangeStart,
          rangeEnd,
        };
      });

      // Calculate total party duty
      const totalDuty = currentTotal;

      // Create the markdown table header
      let tableMarkdown = "## Duty Check Chart\n\n";
      tableMarkdown += "| Range | Duty Type | Character |\n";
      tableMarkdown += "|-------|-----------|-----------|\n";

      // Add each duty to the table
      dutyRanges.forEach((duty) => {
        tableMarkdown += `| ${duty.range} | ${duty.dutyType} | ${duty.characterName} |\n`;
      });

      // Add total duty information
      tableMarkdown += `\n**Total Party Duty: ${totalDuty}**\n\n`;

      // Send the table to the chat
      api.sendMessage(tableMarkdown);
    });
  }

  function rollDuty() {
    api.promptRoll("Duty Roll", "1d100", [], { isNarrative: false }, "duty");
  }

  function rollMorality() {
    api.promptRoll(
      "Morality Conflict Roll",
      "1d10",
      [],
      { isNarrative: false, conflict: record?.data?.conflict || 0 },
      "conflict"
    );
  }

  function onRollCriticalInjury() {
    rollCriticalInjury(record, "injury", []);
  }
</script>

<div style="display: flex; margin-top: 4px; flex-direction: column; gap: 8px">
  <!-- First Flex Row: Portrait | (Species | Career) -->
  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 8px;
      align-items: flex-start;
    "
  >
    <div style="display: flex; flex-direction: column">
      <div
        style="
          width: 138px;
          min-width: 138px;
          max-width: 138px;
          min-height: 138px;
          max-height: 138px;
        "
      >
        <portrait width="138px" height="138px"></portrait>
      </div>
    </div>

    <div style="display: flex; flex-direction: column; gap: 4px; width: 100%">
      <div
        style="
          display: flex;
          flex-direction: row;
          gap: 4px;
          align-items: flex-end;
        "
      >
        <stringfield
          width="100%"
          size="md"
          field="speciesName"
          placeholder="Drag and drop a Species"
          label="Species"
        ></stringfield>
        <list
          width="fit-content"
          height="42px"
          hidden="true"
          listtype="character_species_list"
          field="species"
          onchange="onDeleteSpecies();"
        ></list>
      </div>

      <div
        style="
          display: flex;
          flex-direction: row;
          gap: 4px;
          align-items: flex-end;
        "
      >
        <stringfield
          width="100%"
          size="md"
          field="careerName"
          placeholder="Drag and drop a Career"
          label="Career"
        ></stringfield>
        <list
          width="fit-content"
          height="42px"
          hidden="true"
          listtype="character_career_list"
          field="careers"
          onchange="onDeleteCareer();"
        ></list>
      </div>
    </div>
  </div>

  <!-- Second Flex Row: Stats (Brawn, Agility, Intellect, Cunning, Willpower, Presence) -->
  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 8px;
      width: 100%;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    "
  >
    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      "
    >
      <numberfield
        placeholder="0"
        size="sm"
        width="80px"
        textalign="center"
        field="brawn"
        label="Brawn"
        onchange="updateAttribute({ record, attribute: 'brawn', value })"
        onclick="rollCheck('brawn');"
        onload="onLoadCharacter();"
      ></numberfield>
      <button
        field="Brawn Check"
        size="xs"
        width="80px"
        variant="outline"
        label="Roll"
        onclick="rollCheck('brawn');"
      ></button>
    </div>

    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      "
    >
      <numberfield
        placeholder="0"
        size="sm"
        width="80px"
        field="agility"
        label="Agility"
        textalign="center"
        onchange="updateAttribute({ record, attribute: 'agility', value })"
        onclick="rollCheck('agility');"
      ></numberfield>
      <button
        field="Agility Check"
        size="xs"
        width="80px"
        variant="outline"
        label="Roll"
        onclick="rollCheck('agility');"
      ></button>
    </div>

    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      "
    >
      <numberfield
        placeholder="0"
        size="sm"
        width="80px"
        field="intellect"
        textalign="center"
        label="Intellect"
        onchange="updateAttribute({ record, attribute: 'intellect', value })"
        onclick="rollCheck('intellect');"
      ></numberfield>
      <button
        field="Intellect Check"
        size="xs"
        width="80px"
        variant="outline"
        label="Roll"
        onclick="rollCheck('intellect');"
      ></button>
    </div>

    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      "
    >
      <numberfield
        placeholder="0"
        size="sm"
        width="80px"
        textalign="center"
        field="cunning"
        label="Cunning"
        onchange="updateAttribute({ record, attribute: 'cunning', value })"
        onclick="rollCheck('cunning');"
      ></numberfield>
      <button
        field="Cunning Check"
        size="xs"
        width="80px"
        variant="outline"
        label="Roll"
        onclick="rollCheck('cunning');"
      ></button>
    </div>

    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      "
    >
      <numberfield
        placeholder="0"
        size="sm"
        width="80px"
        textalign="center"
        field="willpower"
        label="Willpower"
        onchange="updateAttribute({ record, attribute: 'willpower', value })"
        onclick="rollCheck('willpower');"
      ></numberfield>
      <button
        field="Willpower Check"
        size="xs"
        width="80px"
        variant="outline"
        label="Roll"
        onclick="rollCheck('willpower');"
      ></button>
    </div>

    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      "
    >
      <numberfield
        placeholder="0"
        size="sm"
        width="80px"
        textalign="center"
        field="presence"
        label="Presence"
        onchange="updateAttribute({ record, attribute: 'presence', value })"
        onclick="rollCheck('presence');"
      ></numberfield>
      <button
        field="Presence Check"
        size="xs"
        width="80px"
        variant="outline"
        label="Roll"
        onclick="rollCheck('presence');"
      ></button>
    </div>
  </div>

  <!-- Third Flex Row: Health Stats -->
  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 6px;
      width: 100%;
      justify-content: center;
      flex-wrap: wrap;
    "
  >
    <numberfield
      placeholder="0"
      size="sm"
      width="90px"
      field="soakValue"
      label="Soak Value"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="120px"
      icon="IconHeartFilled"
      field="woundThreshold"
      label="Wound Threshold"
      color="pink"
      onchange="updateAttribute({ record, attribute: 'woundThreshold', value })"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="90px"
      icon="IconBandageFilled"
      field="wounds"
      label="Wounds"
      color="red"
      minvalue="0"
      onchange="updateAttribute({ record, attribute: 'wounds', value })"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="120px"
      icon="IconHeartbeat"
      field="strainThreshold"
      label="Strain Threshold"
      color="blue"
      onchange="updateAttribute({ record, attribute: 'strainThreshold', value })"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="90px"
      icon="IconActivity"
      field="strain"
      label="Strain"
      color="cyan"
      minvalue="0"
      onchange="updateAttribute({ record, attribute: 'strain', value })"
    ></numberfield>
  </div>

  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 6px;
      width: 100%;
      justify-content: center;
      align-items: flex-end;
    "
  >
    <numberfield
      placeholder="0"
      size="sm"
      width="120px"
      field="defenseMelee"
      icon="IconShield"
      label="Defense (Melee)"
      color="violet"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="120px"
      field="defenseRanged"
      icon="IconShield"
      label="Defense (Ranged)"
      color="violet"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="115px"
      field="spentXp"
      label="Spent XP"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="115px"
      field="xp"
      label="Total XP"
    ></numberfield>

    <iconbutton
      field="Rest"
      size="lg"
      variant="default"
      options='[{"icon": "IconBed", "label": "Rest", "value": "rest"}]'
      onchange=""
      onclick="rest();"
    ></iconbutton>
  </div>

  <!-- Critical Injuries List -->
  <divider label="Critical Injuries"></divider>
  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 8px;
      width: 100%;
      align-items: flex-end;
      justify-content: right;
    "
  >
    <button
      field="rollCriticalInjuryBtn"
      size="xs"
      variant="outline"
      color="primary"
      label="Roll for Critical Injury"
      onclick="onRollCriticalInjury();"
    ></button>
  </div>
  <div style="min-height: 75px; max-height: 200px; overflow-y: auto">
    <list
      listtype="conditions_list"
      field="criticalInjuries"
      height="100%"
      variant="striped"
      onchange="onChangeConditions();"
    ></list>
  </div>

  <!-- Obligation List -->
  <divider label="Obligation"></divider>
  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 8px;
      width: 100;
      align-items: flex-end;
    "
  >
    <div style="width: 70px">
      <label
        field="obligationValueLabel"
        size="xs"
        variant="bold"
        label="Value"
      ></label>
    </div>
    <div style="flex-grow: 1">
      <label
        field="obligationNameLabel"
        size="xs"
        variant="bold"
        label="Obligation Type"
      ></label>
    </div>
    <div style="margin-left: 8px; display: flex; flex-direction: row; gap: 4px">
      <button
        field="showTableBtn"
        size="xs"
        variant="outline"
        color="secondary"
        label="Show Party Table in Chat"
        onclick="showObligationTable();"
      ></button>
      <button
        field="rollObligationBtn"
        size="xs"
        variant="outline"
        color="primary"
        label="Roll for Session"
        onclick="rollObligation();"
      ></button>
    </div>
  </div>
  <div style="min-height: 75px; max-height: 200px; overflow-y: auto">
    <list
      listtype="obligation_list"
      field="obligations"
      height="100%"
      variant="striped"
    ></list>
  </div>

  <!-- Duty List -->
  <divider label="Duty"></divider>
  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 8px;
      width: 100;
      align-items: flex-end;
    "
  >
    <div style="width: 70px">
      <label
        field="dutyValueLabel"
        size="xs"
        variant="bold"
        label="Value"
      ></label>
    </div>
    <div style="flex-grow: 1">
      <label
        field="dutyNameLabel"
        size="xs"
        variant="bold"
        label="Duty Type"
      ></label>
    </div>
    <div style="margin-left: 8px; display: flex; flex-direction: row; gap: 4px">
      <button
        field="showDutyTableBtn"
        size="xs"
        variant="outline"
        color="secondary"
        label="Show Party Table in Chat"
        onclick="showDutyTable();"
      ></button>
      <button
        field="rollDutyBtn"
        size="xs"
        variant="outline"
        color="primary"
        label="Roll for Session"
        onclick="rollDuty();"
      ></button>
    </div>
  </div>
  <div style="min-height: 75px; max-height: 200px; overflow-y: auto">
    <list
      listtype="duty_list"
      field="duties"
      height="100%"
      variant="striped"
    ></list>
  </div>

  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 8px;
      align-items: center;
      justify-content: center;
    "
  >
    <numberfield
      placeholder="0"
      size="sm"
      size="xs"
      field="contributionRank"
      label="Contribution Rank"
    ></numberfield>
  </div>

  <!-- Morality Value and Notes -->
  <divider label="Morality"></divider>
  <!-- Morality: Value, Conflict -->
  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 8px;
      align-items: flex-end;
      justify-content: center;
    "
  >
    <numberfield
      size="sm"
      label="Morality"
      width="100px"
      field="morality"
      defaultvalue="50"
      placeholder="50"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="100px"
      field="conflict"
      label="Conflict"
      minvalue="0"
    ></numberfield>

    <button
      field="moralityRollBtn"
      size="xs"
      variant="outline"
      color="primary"
      label="Conflict Roll"
      onclick="rollMorality();"
    ></button>
  </div>
  <accordion field="moralityAcc" label="Notes" size="xs" variant="filled">
    <richtextfield disablecontrols="true" field="moralityNotes"></richtextfield>
  </accordion>

  <!-- Force Rating -->
  <divider label="Force Rating"></divider>
  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 6px;
      width: 100%;
      justify-content: center;
    "
  >
    <numberfield
      placeholder="0"
      size="sm"
      width="120px"
      field="forceRating"
      label="Total Force Rating"
      onchange="updateForceRating()"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="100px"
      field="committedForce"
      label="Committed"
      onchange="updateForceRating()"
      minvalue="0"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="100px"
      field="remainingForce"
      hidecontrols="true"
      label="Remaining"
      editable="false"
    ></numberfield>
  </div>
</div>
