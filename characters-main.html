<script>
  function onDrop(type, recordLink) {
    if (type === "species") {
      onDropSpecies(type, recordLink);
    } else if (type === "careers") {
      onDropCareer(type, recordLink);
    } else if (type === "conditions") {
      onDropCondition(type, recordLink);
    }
  }

  function onDropSpecies(type, recordLink) {
    const species = record?.data?.species || [];
    const speciesName = recordLink.tooltip;
    const speciesObj = { ...recordLink.value, icon: "IconAlien" };

    const setValues = (updatedRecord) => {
      // Set species name, initial characteristics, initial XP
      const xpSpent = parseInt(record?.data?.spentXp || "0", 10);
      const xpCur = parseInt(record?.data?.xp || "0", 10);
      const valuesToSet = {
        "data.speciesName": speciesName,
        "fields.species.hidden": false,
        "data.brawn": speciesObj?.data?.brawn || 0,
        "data.agility": speciesObj?.data?.agility || 0,
        "data.intellect": speciesObj?.data?.intellect || 0,
        "data.cunning": speciesObj?.data?.cunning || 0,
        "data.willpower": speciesObj?.data?.willpower || 0,
        "data.presence": speciesObj?.data?.presence || 0,
        "data.xp": xpCur,
        "fields.speciesDetailsLabel.hidden": true,
      };

      if (xpSpent === 0 || xpCur === 0) {
        // We have no XP or haven't spent XP, so just set our current XP to initial XP
        valuesToSet["data.xp"] = speciesObj?.data?.startingXp || 0;
      }

      // First set the values, then update the attributes to get the new thresholds
      api.setValues(valuesToSet, (updatedRecord2) => {
        updateAttributes(updatedRecord2);
      });
    };

    if (species.length > 0) {
      // Replace existing species
      api.removeValue("data.species", 0, () => {
        api.addValue("data.species", speciesObj, setValues);
      });
    } else {
      api.addValue("data.species", speciesObj, setValues);
    }
  }

  function onDropCareer(type, recordLink) {
    const careers = record?.data?.careers || [];
    const careerName = recordLink.tooltip;
    const careerObj = { ...recordLink.value, icon: "IconBadge" };

    // We allow multiple careers, so we just add it to the list
    api.addValue("data.careers", careerObj, () => {
      const valuesToSet = {
        "data.careerName": careerName,
        "fields.careers.hidden": false,
        "data.forceRating":
          (careerObj?.data?.forceRating || 0) +
          (record?.data?.forceRating || 0),
      };

      // Mark all career skills
      const careerSkills = careerObj?.data?.skills || "";
      const careerSkillsArray = careerSkills.toLowerCase().split(",");
      // Filter empty strings and trim whitespace
      const careerSkillsArrayFiltered = careerSkillsArray
        .filter((skill) => skill.trim() !== "")
        .map((skill) => skill.trim());
      const skills = record?.data?.skills || [];
      skills.forEach((skill, index) => {
        if (
          careerSkillsArrayFiltered.includes(skill.name.toLowerCase().trim())
        ) {
          valuesToSet[`data.skills.${index}.data.careerOrMinionSkill`] = true;
        }
      });

      api.setValues(valuesToSet, (updatedRecord) => {
        updateAttributes(updatedRecord, valuesToSet);
      });
    });
  }

  function onDeleteSpecies() {
    const valuesToSet = {
      "data.speciesName": "",
      "fields.species.hidden": true,
      "fields.speciesDetailsLabel.hidden": false,
    };

    updateAttributes(record, valuesToSet);

    api.setValues(valuesToSet);
  }

  function onDeleteCareer() {
    const valuesToSet = {
      "data.careerName": "",
      "fields.careers.hidden": true,
    };

    updateAttributes(record, valuesToSet);

    api.setValues(valuesToSet);
  }

  function onDropCondition(type, recordLink) {
    // Requery the record to get the latest record
    api.getRecord(record.recordType, record._id, (actualRecord) => {
      addConditionToRecord(actualRecord, recordLink);
    });
  }

  function onChangeConditions() {
    // Recalculate wounds and strain, and other attributes
    const deletedItem = data.deletedItem;
    if (!deletedItem) return;

    onConditionChange(record, deletedItem);
  }

  function updateForceRating() {
    const baseForceRating = parseInt(record?.data?.forceRating || "0", 10);
    const committedForce = parseInt(record?.data?.committedForce || "0", 10);
    const remainingForce = Math.max(0, baseForceRating - committedForce);

    api.setValues({
      "data.totalForceRating": baseForceRating,
      "data.remainingForce": remainingForce,
    });
  }

  function onLoadCharacter() {
    // Initialize skills if needed
    initializeSkills(record);
  }

  function rest() {
    const currentWounds = parseInt(record?.data?.wounds || "0", 10);
    const newWounds = Math.max(0, currentWounds - 1);

    const valuesToSet = {
      "data.healingUsed": 0,
    };

    // Use updateAttribute to properly recalculate remaining values
    updateAttribute(
      { record, attribute: "wounds", value: newWounds },
      valuesToSet
    );
    updateAttribute({ record, attribute: "strain", value: 0 }, valuesToSet);

    api.setValues(valuesToSet);

    api.sendMessage(
      `Resting for day. Recovered 1 wound (${currentWounds} â†’ ${newWounds}) and all strain.`
    );
  }

  function onRollCriticalInjury() {
    rollCriticalInjury(record, "injury", []);
  }
</script>

<div style="display: flex; margin-top: 4px; flex-direction: column; gap: 8px">
  <!-- First Flex Row: Portrait | (Species | Career) -->
  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 8px;
      align-items: flex-start;
    "
  >
    <div style="display: flex; flex-direction: column">
      <div
        style="
          width: 138px;
          min-width: 138px;
          max-width: 138px;
          min-height: 138px;
          max-height: 138px;
        "
      >
        <portrait width="138px" height="138px"></portrait>
      </div>
    </div>

    <div style="display: flex; flex-direction: column; gap: 4px; width: 100%">
      <div
        style="
          display: flex;
          flex-direction: row;
          gap: 4px;
          align-items: flex-end;
        "
      >
        <stringfield
          width="100%"
          size="md"
          field="speciesName"
          placeholder="Drag and drop a Species"
          label="Species"
        ></stringfield>
        <list
          width="fit-content"
          height="42px"
          hidden="true"
          listtype="character_species_list"
          field="species"
          onchange="onDeleteSpecies();"
        ></list>
      </div>

      <div
        style="
          display: flex;
          flex-direction: row;
          gap: 4px;
          align-items: flex-end;
        "
      >
        <stringfield
          width="100%"
          size="md"
          field="careerName"
          placeholder="Drag and drop a Career"
          label="Career"
        ></stringfield>
        <list
          width="fit-content"
          height="42px"
          hidden="true"
          listtype="character_career_list"
          field="careers"
          onchange="onDeleteCareer();"
        ></list>
      </div>
    </div>
  </div>

  <!-- Second Flex Row: Stats (Brawn, Agility, Intellect, Cunning, Willpower, Presence) -->
  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 8px;
      width: 100%;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    "
  >
    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      "
    >
      <numberfield
        placeholder="0"
        size="sm"
        width="80px"
        textalign="center"
        field="brawn"
        label="Brawn"
        onchange="updateAttribute({ record, attribute: 'brawn', value })"
        onclick="rollCheck('brawn');"
        onload="onLoadCharacter();"
      ></numberfield>
      <button
        field="Brawn Check"
        size="xs"
        width="80px"
        variant="outline"
        label="Roll"
        onclick="rollCheck('brawn');"
      ></button>
    </div>

    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      "
    >
      <numberfield
        placeholder="0"
        size="sm"
        width="80px"
        field="agility"
        label="Agility"
        textalign="center"
        onchange="updateAttribute({ record, attribute: 'agility', value })"
        onclick="rollCheck('agility');"
      ></numberfield>
      <button
        field="Agility Check"
        size="xs"
        width="80px"
        variant="outline"
        label="Roll"
        onclick="rollCheck('agility');"
      ></button>
    </div>

    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      "
    >
      <numberfield
        placeholder="0"
        size="sm"
        width="80px"
        field="intellect"
        textalign="center"
        label="Intellect"
        onchange="updateAttribute({ record, attribute: 'intellect', value })"
        onclick="rollCheck('intellect');"
      ></numberfield>
      <button
        field="Intellect Check"
        size="xs"
        width="80px"
        variant="outline"
        label="Roll"
        onclick="rollCheck('intellect');"
      ></button>
    </div>

    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      "
    >
      <numberfield
        placeholder="0"
        size="sm"
        width="80px"
        textalign="center"
        field="cunning"
        label="Cunning"
        onchange="updateAttribute({ record, attribute: 'cunning', value })"
        onclick="rollCheck('cunning');"
      ></numberfield>
      <button
        field="Cunning Check"
        size="xs"
        width="80px"
        variant="outline"
        label="Roll"
        onclick="rollCheck('cunning');"
      ></button>
    </div>

    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      "
    >
      <numberfield
        placeholder="0"
        size="sm"
        width="80px"
        textalign="center"
        field="willpower"
        label="Willpower"
        onchange="updateAttribute({ record, attribute: 'willpower', value })"
        onclick="rollCheck('willpower');"
      ></numberfield>
      <button
        field="Willpower Check"
        size="xs"
        width="80px"
        variant="outline"
        label="Roll"
        onclick="rollCheck('willpower');"
      ></button>
    </div>

    <div
      style="
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      "
    >
      <numberfield
        placeholder="0"
        size="sm"
        width="80px"
        textalign="center"
        field="presence"
        label="Presence"
        onchange="updateAttribute({ record, attribute: 'presence', value })"
        onclick="rollCheck('presence');"
      ></numberfield>
      <button
        field="Presence Check"
        size="xs"
        width="80px"
        variant="outline"
        label="Roll"
        onclick="rollCheck('presence');"
      ></button>
    </div>
  </div>

  <!-- Third Flex Row: Health Stats -->
  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 6px;
      width: 100%;
      justify-content: center;
      flex-wrap: wrap;
    "
  >
    <numberfield
      placeholder="0"
      size="sm"
      width="90px"
      field="soakValue"
      label="Soak Value"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="120px"
      icon="IconHeartFilled"
      field="woundThreshold"
      label="Wound Threshold"
      color="pink"
      onchange="updateAttribute({ record, attribute: 'woundThreshold', value })"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="90px"
      icon="IconBandageFilled"
      field="wounds"
      label="Wounds"
      color="red"
      minvalue="0"
      onchange="updateAttribute({ record, attribute: 'wounds', value })"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="120px"
      icon="IconHeartbeat"
      field="strainThreshold"
      label="Strain Threshold"
      color="blue"
      onchange="updateAttribute({ record, attribute: 'strainThreshold', value })"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="90px"
      icon="IconActivity"
      field="strain"
      label="Strain"
      color="cyan"
      minvalue="0"
      onchange="updateAttribute({ record, attribute: 'strain', value })"
    ></numberfield>
  </div>

  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 6px;
      width: 100%;
      justify-content: center;
      align-items: flex-end;
    "
  >
    <numberfield
      placeholder="0"
      size="sm"
      width="120px"
      field="defenseMelee"
      icon="IconShield"
      label="Defense (Melee)"
      color="violet"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="120px"
      field="defenseRanged"
      icon="IconShield"
      label="Defense (Ranged)"
      color="violet"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="115px"
      field="spentXp"
      label="Spent XP"
    ></numberfield>

    <numberfield
      placeholder="0"
      size="sm"
      width="115px"
      field="xp"
      label="Total XP"
    ></numberfield>

    <iconbutton
      field="Rest"
      size="lg"
      variant="default"
      options='[{"icon": "IconBed", "label": "Rest", "value": "rest"}]'
      onchange=""
      onclick="rest();"
    ></iconbutton>
  </div>

  <!-- Critical Injuries List -->
  <divider label="Critical Injuries"></divider>
  <div
    style="
      display: flex;
      flex-direction: row;
      gap: 8px;
      width: 100%;
      align-items: flex-end;
      justify-content: right;
    "
  >
    <button
      field="rollCriticalInjuryBtn"
      size="xs"
      variant="outline"
      color="primary"
      label="Roll for Critical Injury"
      onclick="onRollCriticalInjury();"
    ></button>
  </div>
  <list
    listtype="conditions_list"
    field="criticalInjuries"
    variant="striped"
    onchange="onChangeConditions();"
  ></list>
</div>
