<script>
  function onChangeModifiers() {
    let itemDataPath = getNearestParentDataPath(dataPath);
    // Set itemOnly field visible on all modifiers
    const modifiers = value;
    const valuesToSet = {};

    if (itemDataPath) {
      itemDataPath = itemDataPath + ".";
    }

    modifiers.forEach((modifier, index) => {
      valuesToSet[
        `${itemDataPath}data.modifiers.${index}.fields.itemOnly.hidden`
      ] = false;
    });

    if (Object.keys(valuesToSet).length > 0) {
      api.setValues(valuesToSet);
    }
  }

  function onLoad() {
    // Hide if not a weapon
    const itemDataPath = getNearestParentDataPath(dataPath);
    const item = itemDataPath ? api.getValue(itemDataPath) : record;
    const isWeapon =
      (item?.data?.type || "").toLowerCase() === "ranged weapon" ||
      (item?.data?.type || "").toLowerCase() === "melee weapon";
    if (
      (isWeapon && record.fields?.animationProps?.hidden === true) ||
      (isWeapon && record.fields?.animationProps?.hidden === undefined)
    ) {
      api.setHidden("animationProps", false);
    } else if (
      (!isWeapon && record.fields?.animationProps?.hidden === false) ||
      record.fields?.animationProps?.hidden === undefined
    ) {
      api.setHidden("animationProps", true);
    }
  }
</script>

<div style="margin-top: 4px">
  <dropdown
    width="100%"
    field="equipEffect"
    textalign="center"
    size="md"
    label="Effect"
    description="Effect applied when equipped"
    placeholder="Select Effect if Applicable..."
    optionsquery='{"type": "effects", "query": {}}'
    hidewhenidentified="false"
  >
  </dropdown>
</div>

<div style="margin-top: 4px">
  <label label="Modifiers" size="md" variant="bold" textalign="center"></label>
  <label
    label="Modifiers applied when equipped"
    size="sm"
    textalign="center"
    color="dark.2"
  ></label>
</div>

<label
  hidewhenidentified="true"
  label="Item Unidentified"
  size="sm"
  textalign="center"
></label>

<div style="width: 100%">
  <list
    hidewhenidentified="false"
    listtype="modifier_list"
    field="modifiers"
    variant="striped"
    allowadd=""
    onchange="onChangeModifiers();"
  ></list>
</div>

<box field="animationProps" hidden="true">
  <div style="margin-top: 4px">
    <label
      label="Animations"
      size="md"
      variant="bold"
      textalign="center"
    ></label>
    <fxcontrol
      field="animation"
      label="Attack Animation"
      onload="onLoad()"
    ></fxcontrol>
  </div>
</box>
