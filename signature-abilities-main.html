<script>
  function onTalentChange() {
    // Dynamically set initial cost
    const talents = api.getValue(dataPath);

    if (talents && talents.length > 0) {
      let cost = 10;
      if (dataPath.includes("talent1")) {
        cost = 10;
      } else if (dataPath.includes("talent2")) {
        cost = 15;
      }

      api.setValues({
        [`${dataPath}.0.data.cost`]: cost,
      });
    }
  }

  function onLoad() {
    showHideDividers();
  }

  function showHideDividers() {
    const nearestParentDataPath = getNearestParentDataPath(dataPath);
    const specialization = api.getValue(nearestParentDataPath) || record;
    const valuesToSet = {};

    // Check all dividers in the talent tree
    const dividersToCheck = [
      // Row 0 → Row 1 connections
      "connector0_1",
      "connector0_2",
      "connector0_3",
      "connector0_4",

      // Row 1 → Row 2 connections
      "connector1_1",
      "connector1_2",
      "connector1_3",
      "connector1_4",

      // Row 0 horizontal connections
      // Row 1 → Row 2 connections
      "connector2_1",
      "connector2_2",
      "connector2_3",
      "connector2_4",

      // Row 1 horizontal connections
      "h_connector1_2",
      "h_connector1_3",
      "h_connector1_4",

      // Row 2 → Row 3 connections
      "connector3_1",
      "connector3_2",
      "connector3_3",
      "connector3_4",

      // Row 2 horizontal connections
      "h_connector2_2",
      "h_connector2_3",
      "h_connector2_4",
    ];

    dividersToCheck.forEach((divider) => {
      if (
        specialization?.data?.[divider] &&
        specialization?.data?.[divider] === "Yes" &&
        specialization?.fields?.[`${divider}_divider`]?.hidden !== false
      ) {
        valuesToSet[
          `${nearestParentDataPath}${
            nearestParentDataPath ? "." : ""
          }fields.${divider}_divider.hidden`
        ] = false;
      } else if (
        specialization?.data?.[divider] &&
        specialization?.data?.[divider] === "No" &&
        specialization?.fields?.[`${divider}_divider`]?.hidden !== true
      ) {
        valuesToSet[
          `${nearestParentDataPath}${
            nearestParentDataPath ? "." : ""
          }fields.${divider}_divider.hidden`
        ] = true;
      }
    });

    if (Object.keys(valuesToSet).length > 0) {
      api.setValues(valuesToSet);
    }
  }
</script>

<div
  style="
    display: flex;
    gap: 4px;
    flex-direction: column;
    width: 100%;
    margin-bottom: 4px;
  "
>
  <div style="display: flex; gap: 4px; width: 100%">
    <div style="width: 60px; height: 60px; min-height: 60px; min-width: 60px">
      <portrait width="60px" height="60px" field="portrait"></portrait>
    </div>
    <div style="display: flex; flex-direction: row; gap: 4px; width: 400px">
      <stringfield
        width="100%"
        field="career"
        label="Career"
        placeholder="Enter Required Career..."
        onload="onLoad();"
      ></stringfield>
      <numberfield
        width="100%"
        field="cost"
        label="Cost"
        placeholder="Enter Cost..."
      ></numberfield>
    </div>
  </div>

  <label
    variant="bold"
    size="md"
    textalign="center"
    label="Ability and Talents"
  ></label>

  <!-- Connectors to Spec Tree -->
  <div
    style="
      display: flex;
      gap: 36px;
      width: 100%;
      align-items: center;
      justify-content: center;
    "
  >
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        align-items: center;
        width: 250px;
      "
    >
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="connector0_1_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: -4px;
              left: 10px;
              right: 10px;
              bottom: 0;
              height: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="connector0_1"
          variant="default"
          size="md"
          disablediflocked="true"
          onchange="showHideDividers();"
          hideonlocked="true"
          options='[{"label": "Not Connected to Spec Tree", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected Up to Spec Tree", "value": "Yes", "icon": "IconArrowUp"}]'
        ></iconbutton>
      </div>
    </div>
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        align-items: center;
        width: 250px;
      "
    >
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="connector0_2_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: -4px;
              left: 10px;
              right: 10px;
              bottom: 0;
              height: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="connector0_2"
          variant="default"
          size="md"
          disablediflocked="true"
          onchange="showHideDividers();"
          hideonlocked="true"
          options='[{"label": "Not Connected to Spec Tree", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected Up to Spec Tree", "value": "Yes", "icon": "IconArrowUp"}]'
        ></iconbutton>
      </div>
    </div>
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        align-items: center;
        width: 250px;
      "
    >
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="connector0_3_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: -4px;
              left: 10px;
              right: 10px;
              bottom: 0;
              height: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="connector0_3"
          variant="default"
          size="md"
          disablediflocked="true"
          onchange="showHideDividers();"
          hideonlocked="true"
          options='[{"label": "Not Connected to Spec Tree", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected Up to Spec Tree", "value": "Yes", "icon": "IconArrowUp"}]'
        ></iconbutton>
      </div>
    </div>
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        align-items: center;
        width: 250px;
      "
    >
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="connector0_4_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: -4px;
              left: 10px;
              right: 10px;
              bottom: 0;
              height: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="connector0_4"
          variant="default"
          size="md"
          disablediflocked="true"
          onchange="showHideDividers();"
          hideonlocked="true"
          options='[{"label": "Not Connected to Spec Tree", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected Up to Spec Tree", "value": "Yes", "icon": "IconArrowUp"}]'
        ></iconbutton>
      </div>
    </div>
  </div>

  <!-- Skill and Difficulty -->
  <div style="margin-top: 8px">
    <div style="display: flex; gap: 4px; width: 100%">
      <stringfield
        width="100%"
        size="sm"
        field="skill"
        label="Skill"
        placeholder="Enter Skill to Roll if Applicable..."
      ></stringfield>
      <dropdown
        width="100%"
        field="difficulty"
        label="Difficulty"
        placeholder="Select Difficulty..."
        options='[{"label": "None", "value": "None"}, {"label": "Easy (1)", "value": "Easy"},
        {"label": "Average (2)", "value": "Average"}, {"label": "Hard (3)", "value": "Hard"},
        {"label": "Daunting (4)", "value": "Daunting"}, {"label": "Formidable (5)", "value": "Formidable"}]'
      ></dropdown>
    </div>
    <label
      variant="bold"
      size="sm"
      textalign="left"
      label="Description"
    ></label>
    <richtextfield
      width="100%"
      field="description"
      label="Description"
      placeholder="Enter Description..."
    ></richtextfield>
  </div>

  <!-- Row 1 - Talents -->
  <div
    style="
      display: flex;
      gap: 4px;
      width: 100%;
      align-items: center;
      justify-content: center;
    "
  >
    <!-- Talent 1 -->
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        align-items: center;
      "
    >
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="connector1_1_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: -4px;
              left: 10px;
              right: 10px;
              bottom: 0;
              height: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="connector1_1"
          variant="default"
          size="md"
          disablediflocked="true"
          onchange="showHideDividers();"
          hideonlocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
      </div>
      <list
        field="talent1_1"
        size="xs"
        variant="outline"
        width="250px"
        height="200px"
        listtype="signature_ability_talent_list"
        onchange="onTalentChange();"
      ></list>
      <!-- Connection Vertical -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="connector2_1_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: -4px;
              left: 10px;
              right: 10px;
              bottom: 0;
              height: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="connector2_1"
          variant="default"
          size="md"
          disablediflocked="true"
          onchange="showHideDividers();"
          hideonlocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
      </div>
    </div>

    <!-- Connection Horizontal -->
    <div style="position: relative; min-width: 27px; min-height: 27px">
      <box field="h_connector1_2_divider" hidden="true">
        <div
          style="
            position: absolute;
            top: 10px;
            left: -4px;
            right: 0;
            bottom: 10px;
            width: 36px;
            background: var(--mantine-color-primary-filled);
            opacity: 0.75;
          "
        ></div>
      </box>
      <iconbutton
        field="h_connector1_2"
        variant="default"
        size="md"
        disablediflocked="true"
        onchange="showHideDividers();"
        hideonlocked="true"
        options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
      ></iconbutton>
    </div>

    <!-- Talent 2 -->
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        align-items: center;
      "
    >
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="connector1_2_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: -4px;
              left: 10px;
              right: 10px;
              bottom: 0;
              height: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="connector1_2"
          variant="default"
          size="md"
          disablediflocked="true"
          onchange="showHideDividers();"
          hideonlocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
      </div>
      <list
        field="talent1_2"
        size="xs"
        variant="outline"
        width="250px"
        height="200px"
        listtype="signature_ability_talent_list"
        onchange="onTalentChange();"
      ></list>
      <!-- Connection Vertical -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="connector2_2_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: -4px;
              left: 10px;
              right: 10px;
              bottom: 0;
              height: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="connector2_2"
          variant="default"
          size="md"
          disablediflocked="true"
          onchange="showHideDividers();"
          hideonlocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
      </div>
    </div>

    <!-- Connection Horizontal -->
    <div style="position: relative; min-width: 27px; min-height: 27px">
      <box field="h_connector1_3_divider" hidden="true">
        <div
          style="
            position: absolute;
            top: 10px;
            left: -4px;
            right: 0;
            bottom: 10px;
            width: 36px;
            background: var(--mantine-color-primary-filled);
            opacity: 0.75;
          "
        ></div>
      </box>
      <iconbutton
        field="h_connector1_3"
        variant="default"
        size="md"
        disablediflocked="true"
        onchange="showHideDividers();"
        hideonlocked="true"
        options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
      ></iconbutton>
    </div>

    <!-- Talent 3 -->
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        align-items: center;
      "
    >
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="connector1_3_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: -4px;
              left: 10px;
              right: 10px;
              bottom: 0;
              height: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="connector1_3"
          variant="default"
          size="md"
          disablediflocked="true"
          onchange="showHideDividers();"
          hideonlocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
      </div>
      <list
        field="talent1_3"
        size="xs"
        variant="outline"
        width="250px"
        height="200px"
        listtype="signature_ability_talent_list"
        onchange="onTalentChange();"
      ></list>
      <!-- Connection Vertical -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="connector2_3_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: -4px;
              left: 10px;
              right: 10px;
              bottom: 0;
              height: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="connector2_3"
          variant="default"
          size="md"
          disablediflocked="true"
          onchange="showHideDividers();"
          hideonlocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
      </div>
    </div>

    <!-- Connection Horizontal -->
    <div style="position: relative; min-width: 27px; min-height: 27px">
      <box field="h_connector1_4_divider" hidden="true">
        <div
          style="
            position: absolute;
            top: 10px;
            left: -4px;
            right: 0;
            bottom: 10px;
            width: 36px;
            background: var(--mantine-color-primary-filled);
            opacity: 0.75;
          "
        ></div>
      </box>
      <iconbutton
        field="h_connector1_4"
        variant="default"
        size="md"
        disablediflocked="true"
        onchange="showHideDividers();"
        hideonlocked="true"
        options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
      ></iconbutton>
    </div>

    <!-- Talent 4 (no horizontal connector after this) -->
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        align-items: center;
      "
    >
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="connector1_4_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: -4px;
              left: 10px;
              right: 10px;
              bottom: 0;
              height: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>
        <iconbutton
          field="connector1_4"
          variant="default"
          size="md"
          disablediflocked="true"
          onchange="showHideDividers();"
          hideonlocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
      </div>
      <list
        field="talent1_4"
        size="xs"
        variant="outline"
        width="250px"
        height="200px"
        listtype="signature_ability_talent_list"
        onchange="onTalentChange();"
      ></list>
      <!-- Connection Vertical -->
      <div style="position: relative; min-width: 27px; min-height: 27px">
        <box field="connector2_4_divider" hidden="true">
          <div
            style="
              position: absolute;
              top: -4px;
              left: 10px;
              right: 10px;
              bottom: 0;
              height: 36px;
              background: var(--mantine-color-primary-filled);
              opacity: 0.75;
            "
          ></div>
        </box>

        <iconbutton
          field="connector2_4"
          variant="default"
          size="md"
          disablediflocked="true"
          onchange="showHideDividers();"
          hideonlocked="true"
          options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
{"label": "Connected", "value": "Yes", "icon": "IconArrowDown"}]'
        ></iconbutton>
      </div>
    </div>
  </div>

  <!-- Row 2 - Talents -->
  <div
    style="
      display: flex;
      gap: 4px;
      width: 100%;
      align-items: center;
      justify-content: center;
    "
  >
    <!-- Talent 1 -->
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        align-items: center;
      "
    >
      <list
        field="talent2_1"
        size="xs"
        variant="outline"
        width="250px"
        height="200px"
        listtype="signature_ability_talent_list"
        onchange="onTalentChange();"
      ></list>
    </div>

    <!-- Connection Horizontal -->
    <div style="position: relative; min-width: 27px; min-height: 27px">
      <box field="h_connector2_2_divider" hidden="true">
        <div
          style="
            position: absolute;
            top: 10px;
            left: -4px;
            right: 0;
            bottom: 10px;
            width: 36px;
            background: var(--mantine-color-primary-filled);
            opacity: 0.75;
          "
        ></div>
      </box>
      <iconbutton
        field="h_connector2_2"
        variant="default"
        size="md"
        disablediflocked="true"
        onchange="showHideDividers();"
        hideonlocked="true"
        options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
 {"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
      ></iconbutton>
    </div>

    <!-- Talent 2 -->
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        align-items: center;
      "
    >
      <list
        field="talent2_2"
        size="xs"
        variant="outline"
        width="250px"
        height="200px"
        listtype="signature_ability_talent_list"
        onchange="onTalentChange();"
      ></list>
    </div>

    <!-- Connection Horizontal -->
    <div style="position: relative; min-width: 27px; min-height: 27px">
      <box field="h_connector2_3_divider" hidden="true">
        <div
          style="
            position: absolute;
            top: 10px;
            left: -4px;
            right: 0;
            bottom: 10px;
            width: 36px;
            background: var(--mantine-color-primary-filled);
            opacity: 0.75;
          "
        ></div>
      </box>
      <iconbutton
        field="h_connector2_3"
        variant="default"
        size="md"
        disablediflocked="true"
        onchange="showHideDividers();"
        hideonlocked="true"
        options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
 {"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
      ></iconbutton>
    </div>

    <!-- Talent 3 -->
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        align-items: center;
      "
    >
      <list
        field="talent2_3"
        size="xs"
        variant="outline"
        width="250px"
        height="200px"
        listtype="signature_ability_talent_list"
        onchange="onTalentChange();"
      ></list>
    </div>

    <!-- Connection Horizontal -->
    <div style="position: relative; min-width: 27px; min-height: 27px">
      <box field="h_connector2_4_divider" hidden="true">
        <div
          style="
            position: absolute;
            top: 10px;
            left: -4px;
            right: 0;
            bottom: 10px;
            width: 36px;
            background: var(--mantine-color-primary-filled);
            opacity: 0.75;
          "
        ></div>
      </box>
      <iconbutton
        field="h_connector2_4"
        variant="default"
        size="md"
        disablediflocked="true"
        onchange="showHideDividers();"
        hideonlocked="true"
        options='[{"label": "Not Connected", "value": "No", "icon": "IconBlank"}, 
 {"label": "Connected", "value": "Yes", "icon": "IconArrowsLeftRight"}]'
      ></iconbutton>
    </div>

    <!-- Talent 4 (no horizontal connector after this) -->
    <div
      style="
        display: flex;
        flex-direction: column;
        gap: 4px;
        justify-content: center;
        align-items: center;
      "
    >
      <list
        field="talent2_4"
        size="xs"
        variant="outline"
        width="250px"
        height="200px"
        listtype="signature_ability_talent_list"
        onchange="onTalentChange();"
      ></list>
    </div>
  </div>
</div>
