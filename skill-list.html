<script>
  function onRollSkill() {
    let skillDataPath = dataPath.replace(".data.stat", "");
    let skill = api.getValue(skillDataPath);
    rollSkill(record, skill);
  }

  function onOpenSkill() {
    let skillDataPath = dataPath.replace(".data.openSkillBtn", "");
    let skill = api.getValue(skillDataPath);
    const skillName = skill.name;

    const record = api.getRecordByTypeAndName("skills", skillName, (record) => {
      if (record) {
        api.openRecord(record);
      }
    });
  }

  function onChangeCareerOrMinionSkill(value) {
    // If this is a minion, we need to recalculate the skill rank
    const dataPathToSkill = dataPath.replace(".data.careerOrMinionSkill", "");
    const isNPC = record.recordType === "npcs";
    const isMinion =
      isNPC && (!record.data?.type || record.data?.type === "minion");
    if (isMinion) {
      let rank = 0;

      if (value === true) {
        const woundsPerMinion = parseInt(
          record?.data?.woundsPerMinion || "0",
          10
        );
        const totalWounds = parseInt(record?.data?.wounds || "0", 10);
        const woundThreshold = parseInt(
          record?.data?.woundThreshold || "0",
          10
        );
        const minionsDefeated = Math.max(
          0,
          Math.floor((totalWounds - 1) / woundsPerMinion)
        );
        const totalMinions = Math.ceil(woundThreshold / woundsPerMinion);
        const minionsRemaining = Math.max(0, totalMinions - minionsDefeated);

        // If wounds exceeds threshold, all minions are dead
        if (totalWounds > woundThreshold) {
          minionsRemaining = 0;
        }

        rank = Math.max(0, minionsRemaining - 1);
      }

      // Update the skill rank
      const skill = api.getValue(dataPathToSkill);
      if (skill && skill.data?.rank !== rank) {
        api.setValue(dataPathToSkill + ".data.rank", rank);
      }
    }
  }
</script>

<div
  style="
    display: flex;
    flex-direction: row;
    gap: 4px;
    align-items: center;
    min-width: 150px;
  "
>
  <iconbutton
    size="sm"
    field="openSkillBtn"
    variant="default"
    onclick="onOpenSkill()"
    options='[{"label": "View Skill Details", "value": "openSkill", "icon": "IconTools"}]'
  ></iconbutton>

  <checkbox
    field="careerOrMinionSkill"
    size="xs"
    onchange="onChangeCareerOrMinionSkill(value)"
  ></checkbox>

  <div style="min-width: 60px; width: 100%">
    <namefield
      placeholder="Skill name..."
      size="xs"
      width="100%"
      field="namefield"
      variant="tooltip-underline"
    ></namefield>
  </div>

  <stringfield
    placeholder="Group..."
    size="xs"
    width="120px"
    label="Group"
    field="group"
    variant="tooltip-underline"
  ></stringfield>

  <numberfield
    placeholder="0"
    size="xs"
    width="100px"
    field="rank"
    label="Rank"
    variant="tooltip"
    minvalue="0"
  ></numberfield>

  <iconbutton
    size="sm"
    field="stat"
    variant="default"
    options='[{"label": "Brawn", "value": "brawn", "icon": "IconHexagonLetterBFilled"}, 
      {"label": "Agility", "value": "agility", "icon": "IconHexagonLetterAFilled"}, 
      {"label": "Intellect", "value": "intellect", "icon": "IconHexagonLetterIFilled"}, 
      {"label": "Cunning", "value": "cunning", "icon": "IconHexagonLetterCFilled"}, 
      {"label": "Willpower", "value": "willpower", "icon": "IconHexagonLetterWFilled"}, 
      {"label": "Presence", "value": "presence", "icon": "IconHexagonLetterPFilled"}]'
  ></iconbutton>

  <button
    size="xs"
    field="stat"
    width="80px"
    variant="light"
    color="primary"
    label="Roll"
    onclick="onRollSkill()"
  ></button>
</div>
